// Variables globales
let allBooks = [];
let filteredBooks = [];
let suggestionsVisible = false;

// Datos de los libros embebidos (soluci√≥n para CORS)
const booksData = {
  "metadata": {
    "version": "1.0",
    "ultimaActualizacion": "2025-09-11",
    "totalLibros": 8,
    "biblioteca": "SIDAUTO BIBLIOTECA"
  },
  "libros": [
    {
      "id": "LIB001",
      "titulo": "Cien a√±os de soledad",
      "autor": "Gabriel Garc√≠a M√°rquez",
      "isbn": "9780060883287",
      "editorial": "Harper & Row",
      "a√±o": 1967,
      "genero": "Realismo M√°gico",
      "categoria": "Literatura Latinoamericana",
      "ubicacion": "A-1-01",
      "estado": "disponible",
      "descripcion": "Una obra maestra del realismo m√°gico que narra la historia de la familia Buend√≠a a trav√©s de varias generaciones.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780060883287-M.jpg",
      "tags": ["realismo m√°gico", "familia", "generaciones", "macondo", "cl√°sico"]
    },
    {
      "id": "LIB002",
      "titulo": "Don Quijote de la Mancha",
      "autor": "Miguel de Cervantes",
      "isbn": "9780142437230",
      "editorial": "Penguin Classics",
      "a√±o": 1605,
      "genero": "Novela de Caballer√≠a",
      "categoria": "Literatura Espa√±ola",
      "ubicacion": "A-1-02",
      "estado": "disponible",
      "descripcion": "Las aventuras del ingenioso hidalgo Don Quijote y su fiel escudero Sancho Panza.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780142437230-M.jpg",
      "tags": ["caballer√≠a", "aventura", "hidalgo", "sancho panza", "cl√°sico"]
    },
    {
      "id": "LIB003",
      "titulo": "El Amor en los Tiempos del C√≥lera",
      "autor": "Gabriel Garc√≠a M√°rquez",
      "isbn": "9780307389732",
      "editorial": "Vintage Books",
      "a√±o": 1985,
      "genero": "Romance",
      "categoria": "Literatura Latinoamericana",
      "ubicacion": "A-1-03",
      "estado": "disponible",
      "descripcion": "Una historia de amor que trasciende el tiempo y las circunstancias.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780307389732-M.jpg",
      "tags": ["amor", "romance", "tiempo", "c√≥lera", "garc√≠a m√°rquez"]
    },
    {
      "id": "LIB004",
      "titulo": "La Casa de los Esp√≠ritus",
      "autor": "Isabel Allende",
      "isbn": "9780553383805",
      "editorial": "Plaza & Jan√©s",
      "a√±o": 1982,
      "genero": "Realismo M√°gico",
      "categoria": "Literatura Latinoamericana",
      "ubicacion": "A-1-04",
      "estado": "prestado",
      "fechaDevolucion": "2025-09-20",
      "prestadoA": "Mar√≠a Gonz√°lez",
      "descripcion": "Una saga familiar que mezcla realismo m√°gico con cr√≠tica social.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780553383805-M.jpg",
      "tags": ["familia", "esp√≠ritus", "saga", "cr√≠tica social", "chile"]
    },
    {
      "id": "LIB005",
      "titulo": "El T√∫nel",
      "autor": "Ernesto Sabato",
      "isbn": "9788432217770",
      "editorial": "Seix Barral",
      "a√±o": 1948,
      "genero": "Novela Psicol√≥gica",
      "categoria": "Literatura Argentina",
      "ubicacion": "A-1-05",
      "estado": "disponible",
      "descripcion": "Una novela psicol√≥gica que explora la obsesi√≥n y la soledad humana.",
      "portada": "https://covers.openlibrary.org/b/isbn/9788432217770-M.jpg",
      "tags": ["psicol√≥gica", "obsesi√≥n", "soledad", "t√∫nel", "argentina"]
    },
    {
      "id": "LIB006",
      "titulo": "Rayuela",
      "autor": "Julio Cort√°zar",
      "isbn": "9788437604572",
      "editorial": "C√°tedra",
      "a√±o": 1963,
      "genero": "Literatura Experimental",
      "categoria": "Literatura Argentina",
      "ubicacion": "A-1-06",
      "estado": "disponible",
      "descripcion": "Una obra experimental que desaf√≠a las convenciones narrativas tradicionales.",
      "portada": "https://covers.openlibrary.org/b/isbn/9788437604572-M.jpg",
      "tags": ["experimental", "rayuela", "cort√°zar", "narrativa", "vanguardia"]
    },
    {
      "id": "LIB007",
      "titulo": "Pedro P√°ramo",
      "autor": "Juan Rulfo",
      "isbn": "9780802133908",
      "editorial": "Fondo de Cultura Econ√≥mica",
      "a√±o": 1955,
      "genero": "Realismo M√°gico",
      "categoria": "Literatura Mexicana",
      "ubicacion": "A-1-07",
      "estado": "disponible",
      "descripcion": "Una obra fundamental de la literatura mexicana que narra la b√∫squeda de un hijo por su padre en un pueblo fantasmal.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780802133908-M.jpg",
      "tags": ["m√©xico", "fantasmal", "padre", "hijo", "comala"]
    },
    {
      "id": "LIB008",
      "titulo": "Cr√≥nica de una Muerte Anunciada",
      "autor": "Gabriel Garc√≠a M√°rquez",
      "isbn": "9780307475893",
      "editorial": "Vintage Espa√±ol",
      "a√±o": 1981,
      "genero": "Novela Corta",
      "categoria": "Literatura Latinoamericana",
      "ubicacion": "A-1-08",
      "estado": "reservado",
      "reservadoPor": "Carlos M√©ndez",
      "fechaReserva": "2025-09-10",
      "descripcion": "Una investigaci√≥n literaria sobre un crimen anunciado que nadie pudo evitar.",
      "portada": "https://covers.openlibrary.org/b/isbn/9780307475893-M.jpg",
      "tags": ["cr√≥nica", "muerte", "crimen", "anunciada", "honor"]
    }
  ],
  "categorias": [
    "Literatura Latinoamericana",
    "Literatura Espa√±ola", 
    "Literatura Argentina",
    "Literatura Mexicana"
  ],
  "generos": [
    "Realismo M√°gico",
    "Novela de Caballer√≠a",
    "Romance",
    "Novela Psicol√≥gica",
    "Literatura Experimental",
    "Novela Corta"
  ],
  "editoriales": [
    "Harper & Row",
    "Penguin Classics",
    "Vintage Books",
    "Plaza & Jan√©s",
    "Seix Barral",
    "C√°tedra",
    "Fondo de Cultura Econ√≥mica",
    "Vintage Espa√±ol"
  ],
  "estadisticas": {
    "disponibles": 5,
    "prestados": 1,
    "reservados": 2,
    "total": 8
  }
};

// Cargar libros desde datos embebidos (soluci√≥n para CORS)
function loadBooksFromJSON() {
  try {
    console.log('‚úÖ Cargando libros desde datos embebidos...');
    
    if (booksData && booksData.libros && Array.isArray(booksData.libros)) {
      allBooks = booksData.libros;
      console.log(`‚úÖ Se cargaron ${allBooks.length} libros exitosamente`);
      
      // Mostrar mensaje de bienvenida por defecto
      displayBooks([]); // Mostrar mensaje de bienvenida
      
      // Mostrar mensaje de bienvenida en contador
      updateSearchResults(0, 'welcome');
      
      // Actualizar estad√≠sticas
      updateBookStatistics();
      
      // Poblar filtros
      populateFilters(booksData);
      
      console.log('üìö Libros disponibles:', allBooks.map(book => book.titulo));
    } else {
      console.error('‚ùå Estructura de datos incorrecta');
      throw new Error('Estructura de datos incorrecta');
    }
  } catch (error) {
    console.error('‚ùå Error al cargar libros:', error);
    loadFallbackBooks();
  }
}

// Datos de fallback (simplificados para debug)
function loadFallbackBooks() {
  console.log('üîÑ Usando datos de fallback');
  const fallbackData = [
    {
      id: "LIB001",
      titulo: "Cien a√±os de soledad",
      autor: "Gabriel Garc√≠a M√°rquez",
      editorial: "Harper & Row",
      a√±o: 1967,
      genero: "Realismo M√°gico",
      estado: "disponible",
      descripcion: "Una obra maestra del realismo m√°gico que narra la historia de la familia Buend√≠a a trav√©s de varias generaciones.",
      portada: "https://covers.openlibrary.org/b/isbn/9780060883287-M.jpg",
      tags: ["realismo m√°gico", "familia", "generaciones", "macondo", "cl√°sico"]
    },
    {
      id: "LIB002",
      titulo: "Don Quijote de la Mancha",
      autor: "Miguel de Cervantes",
      editorial: "Penguin Classics",
      a√±o: 1605,
      genero: "Novela de Caballer√≠a",
      estado: "disponible",
      descripcion: "Las aventuras del ingenioso hidalgo Don Quijote y su fiel escudero Sancho Panza.",
      portada: "https://covers.openlibrary.org/b/isbn/9780142437230-M.jpg",
      tags: ["caballer√≠a", "aventura", "hidalgo", "sancho panza", "cl√°sico"]
    }
  ];
  
  allBooks = fallbackData;
  filteredBooks = [];
  displayBooks([]);
  updateBookStatistics();
}

// Poblar selectores de filtros
function populateFilters(data) {
  const genreSelect = document.getElementById('genreFilter');
  const editorialSelect = document.getElementById('editorialFilter');
  const yearSelect = document.getElementById('yearFilter');
  
  if (!genreSelect || !editorialSelect || !yearSelect) {
    console.log('‚ö†Ô∏è Algunos selectores de filtros no encontrados');
    return;
  }
  
  // Poblar g√©neros
  if (data.generos) {
    data.generos.forEach(genero => {
      const option = document.createElement('option');
      option.value = genero;
      option.textContent = genero;
      genreSelect.appendChild(option);
    });
  }
  
  // Poblar editoriales
  if (data.editoriales) {
    data.editoriales.forEach(editorial => {
      const option = document.createElement('option');
      option.value = editorial;
      option.textContent = editorial;
      editorialSelect.appendChild(option);
    });
  }
  
  // Poblar a√±os (√∫nicos, ordenados)
  if (data.libros) {
    const years = [...new Set(data.libros.map(libro => libro.a√±o))].sort((a, b) => b - a);
    years.forEach(a√±o => {
      const option = document.createElement('option');
      option.value = a√±o;
      option.textContent = a√±o;
      yearSelect.appendChild(option);
    });
  }
}

// Crear tarjeta de libro mejorada
function createBookCard(libro) {
  const estadoClass = libro.estado || 'disponible';
  const estadoTexto = {
    'disponible': 'Disponible',
    'prestado': 'Prestado',
    'reservado': 'Reservado'
  }[estadoClass] || 'Disponible';
  
  const fallbackImage = `data:image/svg+xml;base64,${btoa(`
    <svg width="300" height="400" viewBox="0 0 300 400" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="bookGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#2c3e50;stop-opacity:1" />
        </linearGradient>
      </defs>
      <rect width="300" height="400" fill="url(#bookGrad)" rx="8"/>
      <rect x="20" y="30" width="260" height="4" fill="rgba(255,255,255,0.3)" rx="2"/>
      <rect x="20" y="50" width="200" fill="rgba(255,255,255,0.8)" rx="2" height="20"/>
      <rect x="20" y="80" width="160" fill="rgba(255,255,255,0.6)" rx="2" height="16"/>
      <rect x="20" y="350" width="260" height="4" fill="rgba(255,255,255,0.3)" rx="2"/>
      <circle cx="150" cy="200" r="40" fill="rgba(255,255,255,0.2)"/>
      <path d="M130 185 L130 215 L170 200 Z" fill="rgba(255,255,255,0.8)"/>
    </svg>
  `)}`;

  return `
    <div class="book-card" onclick="openBookDetails('${libro.titulo}', '${libro.autor}')">
      <img src="${libro.portada}" alt="${libro.titulo}" class="book-cover" 
           onerror="this.src='${fallbackImage}'" />
      <div class="book-info">
        <div class="book-content">
          <h3 class="book-title">${libro.titulo}</h3>
          <p class="book-author">por ${libro.autor}</p>
          <p class="book-description">${libro.descripcion}</p>
        </div>
        
        <div class="book-footer">
          <div class="book-details">
            <div class="detail-row">
              <span class="detail-label">Editorial:</span>
              <span>${libro.editorial}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">A√±o:</span>
              <span>${libro.a√±o}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">G√©nero:</span>
              <span>${libro.genero}</span>
            </div>
          </div>
          
          <div class="book-status ${estadoClass}">${estadoTexto}</div>
        </div>
      </div>
    </div>
  `;
}

// Mostrar libros
function displayBooks(books) {
  const booksGrid = document.getElementById('booksGrid');
  
  if (!booksGrid) return;
  
  if (books.length === 0) {
    // Verificar si es estado inicial o no hay resultados
    const searchInput = document.getElementById('searchInput');
    const quickSearchInput = document.getElementById('quickSearchInput');
    const hasSearch = (searchInput && searchInput.value.trim()) || 
                     (quickSearchInput && quickSearchInput.value.trim());
    
    if (!hasSearch) {
      // Estado inicial - mostrar mensaje de bienvenida
      booksGrid.innerHTML = `
        <div class="welcome-message">
          <div class="welcome-icon">üìö</div>
          <h3>Bienvenido a SIDAUTO BIBLIOTECA</h3>
          <p>Utiliza la barra de b√∫squeda para encontrar libros en nuestra colecci√≥n</p>
          <div class="search-suggestions">
            <p><strong>Puedes buscar por:</strong></p>
            <div class="suggestion-tags">
              <span class="suggestion-tag">T√≠tulo</span>
              <span class="suggestion-tag">Autor</span>
              <span class="suggestion-tag">G√©nero</span>
              <span class="suggestion-tag">Editorial</span>
            </div>
          </div>
        </div>
      `;
    } else {
      // No hay resultados de b√∫squeda
      booksGrid.innerHTML = `
        <div class="no-results">
          <h3>üìö No se encontraron libros</h3>
          <p>Intenta con otros t√©rminos de b√∫squeda</p>
        </div>
      `;
    }
    return;
  }
  
  const booksHTML = books.map(book => createBookCard(book)).join('');
  booksGrid.innerHTML = booksHTML;
}

// Actualizar contador de resultados
function updateSearchResults(count, state = 'search') {
  const resultsSpan = document.getElementById('searchResults');
  if (!resultsSpan) return;
  
  switch (state) {
    case 'welcome':
      // Estado inicial - mensaje de bienvenida
      resultsSpan.innerHTML = `Utiliza la b√∫squeda para explorar nuestra colecci√≥n`;
      break;
    case 'search':
      // Resultados de b√∫squeda
      resultsSpan.innerHTML = `Mostrando <strong>${count}</strong> ${count === 1 ? 'libro' : 'libros'}`;
      break;
    case 'no-results':
      // Sin resultados
      resultsSpan.innerHTML = `No se encontraron libros con esos criterios`;
      break;
    case 'total':
      // Mostrar todos los libros (cuando se hace "limpiar filtros")
      resultsSpan.innerHTML = `Mostrando <strong>${count}</strong> ${count === 1 ? 'libro' : 'libros'} de nuestra colecci√≥n`;
      break;
    default:
      resultsSpan.innerHTML = `Mostrando <strong>${count}</strong> ${count === 1 ? 'libro' : 'libros'}`;
  }
}

// Sistema de b√∫squeda y filtros
function initSearchSystem() {
  const searchInput = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearSearch');
  const genreFilter = document.getElementById('genreFilter');
  const editorialFilter = document.getElementById('editorialFilter');
  const yearFilter = document.getElementById('yearFilter');
  const statusFilter = document.getElementById('statusFilter');
  const resetBtn = document.getElementById('resetFilters');
  
  if (!searchInput) return; // Si no existe el elemento, salir
  
  // B√∫squeda en tiempo real
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    if (clearBtn) {
      clearBtn.classList.toggle('visible', query.length > 0);
    }
    
    // Sincronizar con b√∫squeda r√°pida
    const quickSearchInput = document.getElementById('quickSearchInput');
    if (quickSearchInput && quickSearchInput.value !== query) {
      quickSearchInput.value = query;
    }
    
    applyFilters();
  });
  
  // Bot√≥n limpiar b√∫squeda
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      searchInput.value = '';
      this.classList.remove('visible');
      
      // Limpiar tambi√©n b√∫squeda r√°pida
      const quickSearchInput = document.getElementById('quickSearchInput');
      if (quickSearchInput) {
        quickSearchInput.value = '';
      }
      
      applyFilters();
    });
  }
  
  // Filtros
  [genreFilter, editorialFilter, yearFilter, statusFilter].forEach(filter => {
    if (filter) {
      filter.addEventListener('change', applyFilters);
    }
  });
  
  // Bot√≥n reset
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      searchInput.value = '';
      if (genreFilter) genreFilter.value = '';
      if (editorialFilter) editorialFilter.value = '';
      if (yearFilter) yearFilter.value = '';
      if (statusFilter) statusFilter.value = '';
      if (clearBtn) clearBtn.classList.remove('visible');
      
      // Limpiar tambi√©n b√∫squeda r√°pida
      const quickSearchInput = document.getElementById('quickSearchInput');
      if (quickSearchInput) {
        quickSearchInput.value = '';
      }
      
      applyFilters();
    });
  }
}

// Aplicar filtros de b√∫squeda
function applyFilters() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const selectedGenre = document.getElementById('genreFilter').value;
  const selectedEditorial = document.getElementById('editorialFilter').value;
  const selectedYear = document.getElementById('yearFilter').value;
  const selectedStatus = document.getElementById('statusFilter').value;
  
  filteredBooks = allBooks.filter(libro => {
    // B√∫squeda por texto
    const matchesSearch = query === '' || 
      libro.titulo.toLowerCase().includes(query) ||
      libro.autor.toLowerCase().includes(query) ||
      libro.editorial.toLowerCase().includes(query) ||
      libro.genero.toLowerCase().includes(query) ||
      (libro.tags && libro.tags.some(tag => tag.toLowerCase().includes(query)));
    
    // Filtro por g√©nero
    const matchesGenre = selectedGenre === '' || libro.genero === selectedGenre;
    
    // Filtro por editorial
    const matchesEditorial = selectedEditorial === '' || libro.editorial === selectedEditorial;
    
    // Filtro por a√±o
    const matchesYear = selectedYear === '' || libro.a√±o.toString() === selectedYear;
    
    // Filtro por estado
    const matchesStatus = selectedStatus === '' || libro.estado === selectedStatus;
    
    return matchesSearch && matchesGenre && matchesEditorial && matchesYear && matchesStatus;
  });
  
  displayBooks(filteredBooks);
  
  // Determinar el estado del contador basado en los filtros
  const hasActiveFilters = query || selectedGenre || selectedEditorial || selectedYear || selectedStatus;
  
  if (!hasActiveFilters) {
    // No hay filtros activos - estado de bienvenida
    updateSearchResults(0, 'welcome');
  } else if (filteredBooks.length === 0) {
    // Hay filtros pero no resultados
    updateSearchResults(0, 'no-results');
  } else if (filteredBooks.length === allBooks.length) {
    // Mostrando todos los libros (por ejemplo, b√∫squeda muy general)
    updateSearchResults(filteredBooks.length, 'total');
  } else {
    // Mostrando resultados filtrados
    updateSearchResults(filteredBooks.length, 'search');
  }
}

// Actualizar estad√≠sticas de libros
function updateBookStatistics() {
  // Contar libros por estado
  const stats = {
    disponibles: 0,
    prestados: 0,
    reservados: 0,
    total: allBooks.length
  };
  
  allBooks.forEach(libro => {
    if (libro.estado === 'disponible') {
      stats.disponibles++;
    } else if (libro.estado === 'prestado') {
      stats.prestados++;
    } else if (libro.estado === 'reservado') {
      stats.reservados++;
    }
  });
  
  console.log('üìä Estad√≠sticas actualizadas:', stats);
  
  // Actualizar UI si existen los elementos
  const totalBooksElement = document.getElementById('totalBooks');
  const availableBooksElement = document.getElementById('availableBooks');
  
  if (totalBooksElement) {
    totalBooksElement.textContent = stats.total;
  }
  
  if (availableBooksElement) {
    availableBooksElement.textContent = stats.disponibles;
  }
}

// Funci√≥n de b√∫squeda r√°pida tipo Google con sugerencias
function initQuickSearch() {
  const quickSearchInput = document.getElementById('quickSearchInput');
  
  if (!quickSearchInput) return;
  
  // Crear contenedor de sugerencias
  const suggestionsContainer = createSuggestionsContainer();
  quickSearchInput.parentNode.appendChild(suggestionsContainer);
  
  // B√∫squeda con sugerencias (independiente)
  quickSearchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    
    if (query.length > 0) {
      showSuggestions(query, suggestionsContainer);
    } else {
      hideSuggestions(suggestionsContainer);
    }
  });
  
  // Navegaci√≥n con teclado
  quickSearchInput.addEventListener('keydown', function(e) {
    handleKeyNavigation(e, suggestionsContainer);
  });
  
  // Ocultar sugerencias al perder foco (con delay para permitir clics)
  quickSearchInput.addEventListener('blur', function() {
    setTimeout(() => {
      hideSuggestions(suggestionsContainer);
    }, 150);
  });
  
  // Ocultar sugerencias con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideSuggestions(suggestionsContainer);
      quickSearchInput.blur();
    }
  });
  
  // Al hacer Enter, ejecutar b√∫squeda y ir a la secci√≥n
  quickSearchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const query = this.value.trim();
      if (query.length > 0) {
        executeSearch(query);
        hideSuggestions(suggestionsContainer);
      }
    }
  });
}

// Crear contenedor de sugerencias
function createSuggestionsContainer() {
  const container = document.createElement('div');
  container.className = 'search-suggestions-popup';
  container.style.display = 'none';
  return container;
}

// Mostrar sugerencias
function showSuggestions(query, container) {
  const suggestions = generateSuggestions(query);
  
  if (suggestions.length === 0) {
    hideSuggestions(container);
    return;
  }
  
  const suggestionsHTML = suggestions.map((suggestion, index) => `
    <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
         data-query="${suggestion.query}" 
         data-type="${suggestion.type}">
      <span class="suggestion-icon">${suggestion.icon}</span>
      <div class="suggestion-content">
        <div class="suggestion-text">${suggestion.display}</div>
        <div class="suggestion-type">${suggestion.typeText}</div>
      </div>
    </div>
  `).join('');
  
  container.innerHTML = suggestionsHTML;
  container.style.display = 'block';
  suggestionsVisible = true;
  
  // Agregar event listeners a las sugerencias
  container.querySelectorAll('.suggestion-item').forEach(item => {
    item.addEventListener('click', function() {
      const query = this.dataset.query;
      document.getElementById('quickSearchInput').value = query;
      executeSearch(query);
      hideSuggestions(container);
    });
  });
}

// Generar sugerencias inteligentes
function generateSuggestions(query) {
  const suggestions = [];
  const maxSuggestions = 6;
  
  // B√∫squeda por t√≠tulo
  allBooks.forEach(book => {
    if (book.titulo.toLowerCase().includes(query)) {
      suggestions.push({
        query: book.titulo,
        display: `<strong>${highlightMatch(book.titulo, query)}</strong>`,
        type: 'title',
        typeText: `por ${book.autor}`,
        icon: 'üìñ'
      });
    }
  });
  
  // B√∫squeda por autor
  const authors = [...new Set(allBooks.map(book => book.autor))];
  authors.forEach(author => {
    if (author.toLowerCase().includes(query)) {
      const bookCount = allBooks.filter(book => book.autor === author).length;
      suggestions.push({
        query: author,
        display: `<strong>${highlightMatch(author, query)}</strong>`,
        type: 'author',
        typeText: `${bookCount} libro${bookCount > 1 ? 's' : ''}`,
        icon: 'üë§'
      });
    }
  });
  
  // B√∫squeda por g√©nero
  const genres = [...new Set(allBooks.map(book => book.genero))];
  genres.forEach(genre => {
    if (genre.toLowerCase().includes(query)) {
      const bookCount = allBooks.filter(book => book.genero === genre).length;
      suggestions.push({
        query: genre,
        display: `<strong>${highlightMatch(genre, query)}</strong>`,
        type: 'genre',
        typeText: `${bookCount} libro${bookCount > 1 ? 's' : ''}`,
        icon: 'üìö'
      });
    }
  });
  
  // Limitar n√∫mero de sugerencias y remover duplicados
  return suggestions
    .filter((suggestion, index, self) => 
      index === self.findIndex(s => s.query === suggestion.query)
    )
    .slice(0, maxSuggestions);
}

// Resaltar coincidencias
function highlightMatch(text, query) {
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

// Ocultar sugerencias
function hideSuggestions(container) {
  container.style.display = 'none';
  suggestionsVisible = false;
}

// Ejecutar b√∫squeda y navegar a la secci√≥n
function executeSearch(query) {
  // Scroll a la secci√≥n biblioteca
  const bibliotecaSection = document.getElementById('biblioteca');
  if (bibliotecaSection) {
    bibliotecaSection.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  }
  
  // Aplicar b√∫squeda en la secci√≥n principal
  setTimeout(() => {
    const mainSearchInput = document.getElementById('searchInput');
    if (mainSearchInput) {
      mainSearchInput.value = query;
      applyFilters();
    }
  }, 500);
}

// Navegaci√≥n con teclado en sugerencias
function handleKeyNavigation(e, container) {
  if (!suggestionsVisible) return;
  
  const items = container.querySelectorAll('.suggestion-item');
  const selected = container.querySelector('.suggestion-item.selected');
  
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    const next = selected?.nextElementSibling || items[0];
    updateSelection(selected, next);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    const prev = selected?.previousElementSibling || items[items.length - 1];
    updateSelection(selected, prev);
  } else if (e.key === 'Enter' && selected) {
    e.preventDefault();
    const query = selected.dataset.query;
    document.getElementById('quickSearchInput').value = query;
    executeSearch(query);
    hideSuggestions(container);
  }
}

// Actualizar selecci√≥n en sugerencias
function updateSelection(current, next) {
  if (current) current.classList.remove('selected');
  if (next) next.classList.add('selected');
}

// Funci√≥n para mostrar detalles del libro (placeholder)
function openBookDetails(title, author) {
  alert(`Detalles del libro:\n\nT√≠tulo: ${title}\nAutor: ${author}\n\n¬°Pr√≥ximamente m√°s funcionalidades!`);
}

// Navegaci√≥n suave
function initSmoothScroll() {
  const links = document.querySelectorAll('a[href^="#"]');
  
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      const targetId = this.getAttribute('href');
      const targetElement = document.querySelector(targetId);
      
      if (targetElement) {
        const offsetTop = targetElement.offsetTop - 70; // Altura del navbar
        
        window.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
      }
    });
  });
}

// Funci√≥n para manejar la vista previa de Planner5D
function setupPlanner5DPreview() {
  const previewImage = document.querySelector('.preview-image');
  
  if (previewImage) {
    previewImage.addEventListener('click', function() {
      // Abrir el enlace en una nueva ventana
      window.open('https://planner5d.onelink.me/stDT/lfqcl8l2', '_blank');
      
      // Analytics o tracking (opcional)
      console.log('Usuario abri√≥ el recorrido virtual de Planner5D');
    });
  }
}

// Inicializaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  // Cargar libros desde JSON
  loadBooksFromJSON();
  
  // Inicializar sistema de b√∫squeda
  initSearchSystem();
  
  // Inicializar b√∫squeda r√°pida del navbar
  initQuickSearch();
  
  // Otras funcionalidades
  initSmoothScroll();
  setupPlanner5DPreview();
  
  // Agregar efectos de scroll para el navbar
  window.addEventListener('scroll', function() {
    const navbar = document.querySelector('.navbar');
    if (window.scrollY > 100) {
      navbar.style.background = 'rgba(44, 62, 80, 0.95)';
      navbar.style.backdropFilter = 'blur(10px)';
    } else {
      navbar.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
      navbar.style.backdropFilter = 'none';
    }
  });
});

// Funci√≥n para intentar cargar libros desde Open Library API (opcional)
async function loadBooksFromAPI() {
  try {
    const response = await fetch('https://openlibrary.org/subjects/fiction.json?limit=6');
    const data = await response.json();
    
    if (data.works && data.works.length > 0) {
      const apiBooks = data.works.map(work => ({
        title: work.title,
        author: work.authors && work.authors.length > 0 ? work.authors[0].name : 'Autor desconocido',
        description: work.first_sentence ? work.first_sentence.join(' ') : 'Descripci√≥n no disponible.',
        cover: work.cover_id ? `https://covers.openlibrary.org/b/id/${work.cover_id}-M.jpg` : null
      }));
      
      return apiBooks;
    }
  } catch (error) {
    console.log('No se pudieron cargar libros de la API, usando datos locales:', error);
  }
  
  return booksData; // Fallback a datos locales
}

// Puedes descomentar esta l√≠nea si quieres probar la API
// loadBooksFromAPI().then(books => console.log('Libros cargados:', books));
