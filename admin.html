<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administradores - SIDAUTO BIBLIOTECA</title>
    
    <!-- Favicons para m√°xima compatibilidad -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/libro.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/libro.png">
    <link rel="shortcut icon" href="assets/libro.png" type="image/png">
    <link rel="apple-touch-icon" href="assets/libro.png">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="style.css" />
    
    <style>
      /* Estilos espec√≠ficos para admin */
      .admin-container {
        max-width: 1200px;
        margin: 100px auto 40px;
        padding: 0 20px;
      }
      
      .admin-header {
        background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 5px 20px rgba(230, 126, 34, 0.3);
      }
      
      .admin-header h1 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .admin-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      
      .stat-card {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        text-align: center;
      }
      
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .admin-content {
        background: white;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .admin-toolbar {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .filter-btn {
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        background: white;
        color: #6c757d;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .filter-btn.active {
        background: #e67e22;
        color: white;
        border-color: #e67e22;
      }
      
      .filter-btn:hover {
        background: #f8f9fa;
        border-color: #e67e22;
      }
      
      .filter-btn.active:hover {
        background: #d35400;
      }
      
      .logout-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .logout-btn:hover {
        background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        transform: translateY(-2px);
      }
      
      .requests-grid {
        padding: 20px;
      }
      
      .request-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
      }
      
      .request-item:hover {
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        transform: translateY(-2px);
      }
      
      .request-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .book-info {
        flex: 1;
        min-width: 250px;
      }
      
      .book-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      
      .book-author {
        color: #6c757d;
        margin-bottom: 5px;
      }
      
      .book-code {
        font-size: 0.9rem;
        color: #95a5a6;
      }
      
      .request-status {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      
      .status-pendiente {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      
      .status-no-disponible {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .status-prestado {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-ocupado {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }
      
      .request-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      
      .btn-details {
        background: #3498db;
        color: white;
      }
      
      .btn-details:hover {
        background: #2980b9;
        transform: translateY(-1px);
      }
      
      .btn-accept {
        background: #27ae60;
        color: white;
      }
      
      .btn-accept:hover {
        background: #229954;
        transform: translateY(-1px);
      }
      
      .btn-deny {
        background: #e74c3c;
        color: white;
      }
      
      .btn-deny:hover {
        background: #c0392b;
        transform: translateY(-1px);
      }
      
      .btn-return {
        background: #17a2b8;
        color: white;
      }
      
      .btn-return:hover {
        background: #138496;
        transform: translateY(-1px);
      }
      
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }
      
      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }
      
      @media (max-width: 768px) {
        .admin-container {
          margin-top: 80px;
          padding: 0 10px;
        }
        
        .admin-toolbar {
          flex-direction: column;
          align-items: stretch;
        }
        
        .filter-buttons {
          justify-content: center;
        }
        
        .request-header {
          flex-direction: column;
        }
        
        .request-actions {
          justify-content: center;
        }
      }
      
      /* === ESTILOS DEL MODAL DE DETALLES === */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
      }
      
      .book-details-content {
        background: #fff;
        margin: 0 20px;
        padding: 0;
        border: none;
        border-radius: 15px;
        width: 100%;
        max-width: 700px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
      }
      
      .book-details-content .modal-header {
        background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        color: white;
        padding: 25px;
        border-radius: 15px 15px 0 0;
        position: relative;
      }
      
      .book-detail-header {
        display: flex;
        align-items: flex-start;
        gap: 20px;
      }
      
      .book-icon-large {
        font-size: 3rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 12px;
        min-width: 80px;
        text-align: center;
      }
      
      .book-header-info h2 {
        margin: 0 0 8px 0;
        font-size: 1.4rem;
        font-weight: 600;
        line-height: 1.3;
      }
      
      .book-header-info h4 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        opacity: 0.9;
        font-weight: normal;
      }
      
      .book-code {
        background: rgba(255, 255, 255, 0.9);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-block;
      }
      
      .modal-close {
        position: absolute;
        top: 20px;
        right: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      
      .modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
      }
      
      .book-details-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
      }
      
      .book-description-section h3,
      .book-metadata h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 1.1rem;
        font-weight: 600;
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 8px;
      }
      
      .book-description-section p {
        color: #555;
        line-height: 1.6;
        margin-bottom: 25px;
      }
      
      .book-status-section {
        margin-top: 20px;
      }
      
      .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
      }
      
      .status-badge.status-disponible {
        background: #d4edda;
        color: #155724;
      }
      
      .status-badge.status-pendiente {
        background: #fff3cd;
        color: #856404;
      }
      
      .status-badge.status-prestado {
        background: #cce7ff;
        color: #004085;
      }
      
      .status-badge.status-ocupado {
        background: #e2e3e5;
        color: #383d41;
      }
      
      .details-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      
      .detail-row:last-child {
        border-bottom: none;
      }
      
      .detail-label {
        font-weight: 600;
        color: #2c3e50;
        min-width: 120px;
      }
      
      .modal-footer {
        padding: 20px 30px;
        background: #f8f9fa;
        border-radius: 0 0 15px 15px;
        text-align: center;
      }
      
      .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
      }
      
      /* Responsive para el modal */
      @media (max-width: 768px) {
        .book-details-content {
          margin: 10px;
          max-height: 95vh;
        }
        
        .book-details-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }
        
        .book-detail-header {
          flex-direction: column;
          text-align: center;
          gap: 15px;
        }
        
        .book-icon-large {
          align-self: center;
        }
        
        .modal-body {
          padding: 20px;
        }
        
        .book-details-content .modal-header {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="nav-container">
          <a href="index.html" class="nav-logo">SIDAUTO BIBLIOTECA</a>
          
          <!-- Barra de b√∫squeda r√°pida -->
          <div class="quick-search">
            <input type="text" id="quickSearchInput" placeholder="Buscar libros...">
          </div>
          
          <!-- Navegaci√≥n entre p√°ginas -->
          <div class="nav-links">
            <a href="index.html" class="nav-link">Inicio</a>
            <a href="biblioteca.html" class="nav-link">Biblioteca Virtual</a>
            <a href="espacios.html" class="nav-link">Nuestro Espacio</a>
          </div>
        </div>
      </nav>
    </header>

    <main>
      <div class="admin-container">
        <!-- Header del Admin -->
        <div class="admin-header">
          <h1>
            Panel de Administradores
            <span id="adminWelcome" style="font-size: 0.8rem; font-weight: normal; margin-left: auto;"></span>
          </h1>
          
          <div class="admin-stats">
            <div class="stat-card">
              <div class="stat-number" id="totalRequests">0</div>
              <div>Solicitudes Totales</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="pendingRequests">0</div>
              <div>Pendientes</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="unavailableRequests">0</div>
              <div>No Disponibles</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="borrowedBooks">0</div>
              <div>Libros Prestados</div>
            </div>
          </div>
        </div>

        <!-- Contenido del Admin -->
        <div class="admin-content">
          <div class="admin-toolbar">
            <div class="filter-buttons">
              <button class="filter-btn active" data-filter="all">
                üìö Todos
              </button>
              <button class="filter-btn" data-filter="PENDIENTE">
                Pendientes
              </button>
              <button class="filter-btn" data-filter="PRESTADO">
                Prestados
              </button>
              <!--<button class="filter-btn" data-filter="OCUPADO">
                Ocupados
              </button>-->
            </div>
            
            <button class="logout-btn" onclick="logoutAdmin()">
              Cerrar Sesi√≥n
            </button>
          </div>
          
          <div class="requests-grid" id="requestsContainer">
            <!-- Aqu√≠ se cargar√°n las solicitudes din√°micamente -->
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 SIDAUTO BIBLIOTECA. Panel de administraci√≥n seguro.</p>
      </div>
    </footer>

    <script src="script.js"></script>
    <script>
      // Debug inicial al cargar admin.html
      console.log('üöÄ admin.html cargado completamente');
      console.log('üïí Timestamp:', new Date().toLocaleString());
      console.log('üîç Estado inicial de storages...');
      
      // Verificar autenticaci√≥n al cargar la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOMContentLoaded ejecutado en admin.html');
        
        // Debug completo de storages
        console.log('=== ESTADO COMPLETO DE STORAGES ===');
        console.log('localStorage.length:', localStorage.length);
        console.log('sessionStorage.length:', sessionStorage.length);
        
        console.log('=== CONTENIDO localStorage ===');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          console.log(`${key}: ${value}`);
        }
        
        console.log('=== CONTENIDO sessionStorage ===');
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          const value = sessionStorage.getItem(key);
          console.log(`${key}: ${value}`);
        }
        console.log('=== FIN DEBUG STORAGES ===');
        
        checkAdminAuth();
        loadAdminRequests();
        initAdminPanel();
      });
      
      // Verificar autenticaci√≥n de administrador
      function checkAdminAuth() {
        console.log('üîê Verificando autenticaci√≥n de administrador...');
        
        // Intentar obtener sesi√≥n de localStorage primero
        let adminSession = localStorage.getItem('sidauto_admin');
        console.log('üìã Sesi√≥n encontrada en localStorage:', adminSession ? 'S√ç' : 'NO');
        
        // Si no est√° en localStorage, intentar sessionStorage
        if (!adminSession) {
          adminSession = sessionStorage.getItem('sidauto_admin');
          console.log('üìã Sesi√≥n encontrada en sessionStorage:', adminSession ? 'S√ç' : 'NO');
          
          // Si encontramos en sessionStorage, restaurar en localStorage
          if (adminSession) {
            console.log('üîÑ Restaurando sesi√≥n desde sessionStorage a localStorage');
            localStorage.setItem('sidauto_admin', adminSession);
          }
        }
        
        if (!adminSession) {
          console.error('‚ùå No hay sesi√≥n de admin en ning√∫n storage');
          console.log('üîç Contenido completo de localStorage:');
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            console.log(`  ${key}: ${localStorage.getItem(key)}`);
          }
          alert('‚ùå Acceso denegado. Debes iniciar sesi√≥n como administrador.');
          window.location.href = 'index.html';
          return;
        }
        
        try {
          const admin = JSON.parse(adminSession);
          console.log('üë§ Datos del admin:', admin);
          
          // Verificar que la sesi√≥n no haya expirado (24 horas)
          const now = Date.now();
          const loginTime = admin.loginTime;
          const sessionDuration = 24 * 60 * 60 * 1000; // 24 horas
          
          console.log('‚è±Ô∏è Verificaci√≥n de tiempo:');
          console.log('  - Ahora:', new Date(now).toLocaleString());
          console.log('  - Login:', new Date(loginTime).toLocaleString());
          console.log('  - Diferencia (ms):', now - loginTime);
          console.log('  - Expirado:', now - loginTime > sessionDuration);
          
          if (now - loginTime > sessionDuration) {
            console.warn('‚è∞ Sesi√≥n expirada');
            localStorage.removeItem('sidauto_admin');
            alert('‚è∞ Tu sesi√≥n ha expirado. Por favor inicia sesi√≥n nuevamente.');
            window.location.href = 'index.html';
            return;
          }
          
          // Mostrar bienvenida
          const welcomeElement = document.getElementById('adminWelcome');
          if (welcomeElement) {
            welcomeElement.textContent = `Bienvenido, ${admin.usuario}`;
          }
          
          console.log('‚úÖ Autenticaci√≥n exitosa para:', admin.usuario);
          
        } catch (error) {
          console.error('üí• Error al verificar sesi√≥n:', error);
          localStorage.removeItem('sidauto_admin');
          alert('‚ùå Error en la sesi√≥n. Por favor inicia sesi√≥n nuevamente.');
          window.location.href = 'index.html';
        }
      }
      
      // Cargar solicitudes de administrador
      async function loadAdminRequests() {
        try {
          // Cargar libros con disponibilidad pendiente o no disponible
          const { data: books, error } = await supabase
            .from('libros')
            .select('*')
            .in('disponibilidad', ['PENDIENTE', 'PRESTADO', 'OCUPADO']);
          
          if (error) {
            throw error;
          }
          
          displayAdminRequests(books || []);
          updateAdminStats(books || []);
          
        } catch (error) {
          console.error('Error al cargar solicitudes:', error);
          const container = document.getElementById('requestsContainer');
          if (container) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">‚ùå</div>
                <h3>Error al cargar las solicitudes</h3>
                <p>Por favor recarga la p√°gina o contacta al soporte t√©cnico.</p>
              </div>
            `;
          }
        }
      }
      
      // Mostrar solicitudes
      function displayAdminRequests(books) {
        const container = document.getElementById('requestsContainer');
        
        if (!books || books.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <h3>No hay solicitudes pendientes</h3>
              <p>Todas las solicitudes han sido procesadas.</p>
            </div>
          `;
          return;
        }
        
        const requestsHTML = books.map(book => {
          const disponibilidad = (book.disponibilidad || 'PENDIENTE').toUpperCase();
          const statusClass = disponibilidad === 'PENDIENTE' ? 'status-pendiente' : 
                             disponibilidad === 'PRESTADO' ? 'status-prestado' : 'status-ocupado';
          const statusText = disponibilidad === 'PENDIENTE' ? 'Pendiente' : 
                            disponibilidad === 'PRESTADO' ? 'Prestado' : 'Ocupado';

          return `
            <div class="request-item" data-status="${disponibilidad.toLowerCase()}">
              <div class="request-header">
                <div class="book-info">
                  <div class="book-title">üìñ ${book.TITULO || 'Sin t√≠tulo'}</div>
                  <div class="book-author">üë§ ${book.AUTOR || 'Autor desconocido'}</div>
                  <div class="book-code">üîç ${book['C√ìDIGO'] || book.No || book.id}</div>
                </div>
                <div class="request-status ${statusClass}">${statusText}</div>
              </div>
              
              <div class="request-actions">
                <button class="action-btn btn-details" onclick="showBookDetails('${book.No || book.id}')">
                  Ver Detalles
                </button>
                ${disponibilidad === 'PRESTADO' 
                  ? `<button class="action-btn btn-return" onclick="returnBook('${book.No || book.id}')">
                       üìö Marcar como Devuelto
                     </button>`
                  : `<button class="action-btn btn-accept" onclick="acceptRequest('${book.No || book.id}')">
                       ‚úÖ Aceptar/Prestar
                     </button>
                     <button class="action-btn btn-deny" onclick="denyRequest('${book.No || book.id}')">
                       ‚ùå Negar/Cancelar
                     </button>`
                }
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = requestsHTML;
      }
      
      // Actualizar estad√≠sticas
      function updateAdminStats(books) {
        const totalElement = document.getElementById('totalRequests');
        const pendingElement = document.getElementById('pendingRequests');
        const unavailableElement = document.getElementById('unavailableRequests');
        const borrowedElement = document.getElementById('borrowedBooks');
        
        const total = books.length;
        const pending = books.filter(book => 
          (book.disponibilidad || '').toUpperCase() === 'PENDIENTE'
        ).length;
        const borrowed = books.filter(book => 
          (book.disponibilidad || '').toUpperCase() === 'PRESTADO'
        ).length;
        const unavailable = books.filter(book => 
          (book.disponibilidad || '').toUpperCase() === 'OCUPADO'
        ).length;
        
        if (totalElement) totalElement.textContent = total;
        if (pendingElement) pendingElement.textContent = pending;
        if (borrowedElement) borrowedElement.textContent = borrowed;
        if (unavailableElement) unavailableElement.textContent = unavailable;
      }
      
      // Inicializar panel de admin
      function initAdminPanel() {
        // Filtros
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            filterRequests(filter);
          });
        });
      }
      
      // Filtrar solicitudes
      function filterRequests(filter) {
        const items = document.querySelectorAll('.request-item');
        
        items.forEach(item => {
          const status = item.dataset.status.toUpperCase();
          
          if (filter === 'all') {
            item.style.display = 'block';
          } else if (filter === 'PENDIENTE') {
            item.style.display = status === 'PENDIENTE' ? 'block' : 'none';
          } else if (filter === 'PRESTADO') {
            item.style.display = status === 'PRESTADO' ? 'block' : 'none';
          } else if (filter === 'OCUPADO') {
            item.style.display = status === 'OCUPADO' ? 'block' : 'none';
          }
        });
      }
      
      // Mostrar detalles del libro
      async function showBookDetails(bookId) {
        try {
          // Obtener el libro completo de la base de datos
          const { data: book, error } = await supabase
            .from('libros')
            .select('*')
            .eq('No', bookId)
            .single();
          
          if (error || !book) {
            alert('‚ùå No se encontraron detalles para este libro.');
            return;
          }
          
          // Transformar el libro al formato esperado
          const libroFormateado = {
            id: `LIB${String(book.No || book.id).padStart(4, '0')}`,
            titulo: book.TITULO || 'Sin t√≠tulo',
            autor: book.AUTOR || 'Autor desconocido',
            isbn: book.ISBN || '',
            editorial: book.EDITORIAL || 'Editorial desconocida',
            a√±o: parseInt(book['A√ëO DE PUBLICACI√ìN']) || 0,
            genero: book.MATERIA || 'Sin clasificar',
            categoria: book.MATERIA || 'General',
            ubicacion: book['UBICACI√ìN '] || 'No especificada',
            codigo: book['C√ìDIGO'] || book.No || book.id,
            disponibilidad: book.disponibilidad || 'DISPONIBLE',
            estado: book.disponibilidad?.toLowerCase() || 'disponible',
            descripcion: `Libro de ${book.MATERIA || 'literatura'} ${book['A√ëO DE PUBLICACI√ìN'] ? `publicado en ${book['A√ëO DE PUBLICACI√ìN']}` : 'sin fecha'}.`,
            fechaAdquisicion: book['FECHA DE ADQUISICI√ìN '] || '',
            edicion: book['NUMERO EDICION'] || '1era',
            cantidad: parseInt(book.CANTIDAD) || 1,
            supabaseId: book.No || book.id
          };
          
          // Mostrar el modal de detalles
          showBookDetailsModal(libroFormateado);
          
        } catch (error) {
          console.error('Error al cargar detalles del libro:', error);
          alert('‚ùå Error al cargar los detalles del libro.');
        }
      }
      
      // Funci√≥n para mostrar el modal de detalles
      function showBookDetailsModal(libro) {
        // Crear modal si no existe
        let modal = document.getElementById('bookDetailsModal');
        if (!modal) {
          modal = createBookDetailsModal();
          document.body.appendChild(modal);
        }
        
        // Determinar estado del libro
        const estadoClass = libro.estado || 'disponible';
        const estadoTexto = {
          'disponible': 'Disponible',
          'pendiente': 'Pendiente',
          'prestado': 'Prestado',
          'ocupado': 'Ocupado'
        }[estadoClass] || 'Disponible';
        
        // Crear icono del g√©nero
        const genreIcon = {
          'LITERATURA': 'üìö', 'FICCI√ìN': 'üìñ', 'HISTORIA': 'üèõÔ∏è', 'CIENCIAS': 'üî¨',
          'ARTE': 'üé®', 'FILOSOF√çA': 'üí≠', 'DERECHO': '‚öñÔ∏è', 'MEDICINA': 'üè•',
          'MATEM√ÅTICAS': '‚ûï', 'INGENIER√çA': '‚öôÔ∏è', 'ECONOM√çA': 'üíº', 'PSICOLOG√çA': 'üß†',
          'EDUCACI√ìN': 'üéì', 'RELIGI√ìN': '‚úùÔ∏è', 'DEPORTES': '‚öΩ', 'COCINA': 'üç≥',
          'VIAJES': '‚úàÔ∏è', 'BIOGRAF√çA': 'üë§', 'AUTOAYUDA': 'üí™', 'NOVELA': 'üìò'
        }[libro.genero?.toUpperCase()] || 'üìö';
        
        // Funci√≥n auxiliar para validar valores
        const isValidValue = (value) => {
          return value && 
                 value !== 'N/D' && 
                 value !== 'No especificado' && 
                 value !== 'No especificada' && 
                 value !== 'No tiene' &&
                 value !== 'Sin clasificar' &&
                 value !== 'Editorial desconocida' &&
                 value !== 'Autor desconocido' &&
                 value !== 'Sin t√≠tulo' &&
                 value !== '' &&
                 value !== null &&
                 value !== undefined &&
                 value.toString().trim() !== '';
        };
        
        // Crear detalles filtrados
        const details = [];
        
        if (isValidValue(libro.editorial)) {
          details.push(`
            <div class="detail-row">
              <span class="detail-label">üìè Editorial:</span>
              <span>${libro.editorial}</span>
            </div>
          `);
        }
        
        if (isValidValue(libro.a√±o) && libro.a√±o > 0) {
          details.push(`
            <div class="detail-row">
              <span class="detail-label">üìÖ A√±o:</span>
              <span>${libro.a√±o}</span>
            </div>
          `);
        }
        
        if (isValidValue(libro.isbn)) {
          details.push(`
            <div class="detail-row">
              <span class="detail-label">üî¢ ISBN:</span>
              <span>${libro.isbn}</span>
            </div>
          `);
        }
        
        if (isValidValue(libro.ubicacion)) {
          details.push(`
            <div class="detail-row">
              <span class="detail-label">üìç Ubicaci√≥n:</span>
              <span>${libro.ubicacion}</span>
            </div>
          `);
        }
        
        if (isValidValue(libro.cantidad) && libro.cantidad > 1) {
          details.push(`
            <div class="detail-row">
              <span class="detail-label">üì¶ Cantidad:</span>
              <span>${libro.cantidad}</span>
            </div>
          `);
        }
        
        // Llenar el contenido del modal
        modal.innerHTML = `
          <div class="modal-content book-details-content">
            <div class="modal-header">
              <div class="book-detail-header">
                <div class="book-icon-large">${genreIcon}</div>
                <div class="book-header-info">
                  <h2>${libro.titulo}</h2>
                  <h4>por ${libro.autor}</h4>
                  <div class="book-code">C√≥digo: ${libro.codigo}</div>
                </div>
              </div>
              <button class="modal-close" onclick="closeBookDetailsModal()">&times;</button>
            </div>
            
            <div class="modal-body">
              <div class="book-details-grid">
                <div class="book-description-section">
                  <h3>üìñ Descripci√≥n</h3>
                  <p>${libro.descripcion}</p>
                  
                  <div class="book-status-section">
                    <h3>üìä Estado actual</h3>
                    <div class="status-badge status-${estadoClass}">${estadoTexto}</div>
                  </div>
                </div>
                
                ${details.length > 0 ? `
                  <div class="book-metadata">
                    <h3>üìã Informaci√≥n adicional</h3>
                    <div class="details-list">
                      ${details.join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
            
            <div class="modal-footer">
              <button class="btn-secondary" onclick="closeBookDetailsModal()">Cerrar</button>
            </div>
          </div>
        `;
        
        // Mostrar el modal
        modal.style.display = 'flex';
      }
      
      // Funci√≥n para crear el modal de detalles si no existe
      function createBookDetailsModal() {
        const modal = document.createElement('div');
        modal.id = 'bookDetailsModal';
        modal.className = 'modal';
        return modal;
      }
      
      // Funci√≥n para cerrar el modal de detalles
      function closeBookDetailsModal() {
        const modal = document.getElementById('bookDetailsModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }
      
      // Aceptar solicitud
      async function acceptRequest(bookId) {
        if (!confirm('¬øEst√°s seguro de que deseas ACEPTAR esta solicitud y marcar el libro como prestado?')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('libros')
            .update({ disponibilidad: 'PRESTADO' })
            .eq('No', bookId);
          
          if (error) throw error;
          
          alert('‚úÖ Solicitud aceptada. El libro ha sido marcado como prestado.');
          loadAdminRequests(); // Recargar la lista
          
        } catch (error) {
          console.error('Error al aceptar solicitud:', error);
          alert('‚ùå Error al procesar la solicitud. Por favor intenta nuevamente.');
        }
      }
      
      // Negar solicitud
      async function denyRequest(bookId) {
        if (!confirm('¬øEst√°s seguro de que deseas NEGAR esta solicitud y devolver el libro a disponible?')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('libros')
            .update({ disponibilidad: 'DISPONIBLE' })
            .eq('No', bookId);
          
          if (error) throw error;
          
          alert('‚ùå Solicitud negada. El libro ha sido devuelto al estado disponible.');
          loadAdminRequests(); // Recargar la lista
          
        } catch (error) {
          console.error('Error al negar solicitud:', error);
          alert('‚ùå Error al procesar la solicitud. Por favor intenta nuevamente.');
        }
      }
      
      // Marcar libro como devuelto
      async function returnBook(bookId) {
        if (!confirm('¬øEst√°s seguro de que deseas marcar este libro como DEVUELTO?')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('libros')
            .update({ disponibilidad: 'DISPONIBLE' })
            .eq('No', bookId);
          
          if (error) throw error;
          
          alert('üìö ¬°Libro devuelto exitosamente! El libro est√° ahora disponible para nuevos pr√©stamos.');
          loadAdminRequests(); // Recargar la lista
          
        } catch (error) {
          console.error('Error al procesar devoluci√≥n:', error);
          alert('‚ùå Error al procesar la devoluci√≥n. Por favor intenta nuevamente.');
        }
      }
      
      // Cerrar sesi√≥n de administrador
      function logoutAdmin() {
        if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('sidauto_admin');
          alert('üëã Sesi√≥n cerrada correctamente.');
          window.location.href = 'index.html';
        }
      }
    </script>
  </body>
</html>
